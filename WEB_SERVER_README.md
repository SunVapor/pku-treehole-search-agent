# Web 界面服务

## 📱 快速访问

**校园网内访问**:
```
http://10.129.83.176:5000
```

用浏览器打开上述地址即可使用图形界面查询！

## ✨ 功能特性

### 三种查询模式

1. **手动检索** 🔍
   - 指定关键词
   - 输入你的问题
   - 适合明确搜索目标的场景

2. **智能检索** 🤖 (推荐)
   - 自然语言提问
   - AI 自动决策搜索策略
   - 支持多轮迭代搜索
   - 实时显示搜索过程

3. **课程测评** 📚
   - 输入课程 + 老师
   - 支持多老师横向对比
   - 深度测评分析

### 核心特性

- ✅ **任务队列**: 多人同时使用，自动排队处理
- ✅ **流式输出**: 实时显示 AI 回答过程
- ✅ **搜索可视化**: 清晰展示每次搜索的关键词和原因
- ✅ **响应式设计**: 支持手机、平板、电脑访问

## 🖥️ 界面说明

### 主界面

```
┌─────────────────────────────────────┐
│   🌲 北大树洞检索 Agent              │
│   校园网内网服务 · 10.129.83.176   │
├─────────────────────────────────────┤
│  [手动检索] [智能检索] [课程测评]   │
├─────────────────────────────────────┤
│                                     │
│  输入区域...                        │
│                                     │
│  [开始查询]                         │
├─────────────────────────────────────┤
│  状态: 运行中...                    │
│  ┌───────────────────────────────┐ │
│  │ 实时输出显示区域              │ │
│  │                               │ │
│  │ 搜索过程 (2次):               │ │
│  │ 1. 计算机网络 - 搜索课程信息   │ │
│  │ 2. 网络 给分 - 搜索给分情况    │ │
│  │                               │ │
│  │ [回答内容...]                 │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 使用示例

**示例 1: 智能检索**
```
模式: 智能检索
问题: 我想了解计算机图形学这门课，作业多吗？

↓ 点击[开始查询]

实时输出:
✓ 任务已提交
✓ 开始处理查询...

搜索过程 (2次):
1. 计算机图形学 作业 - 搜索作业相关信息
2. 图形学 难度 给分 - 搜索难度和给分情况

[详细回答...]

参考来源: 15 个帖子
✓ 完成
```

**示例 2: 课程测评**
```
模式: 课程测评
课程: 计网
老师: hq,zhx  (支持多个老师，用逗号分隔)

↓ 点击[开始查询]

实时输出:
✓ 任务已提交
✓ 开始处理查询...

模式: 课程测评分析
课程: 计网
老师: hq,zhx

[横向对比分析...]
```

## 🔧 技术架构

```
┌──────────────┐
│  浏览器客户端 │
└──────┬───────┘
       │ HTTP + SSE
       ↓
┌──────────────┐
│ Flask Server │
│  (Port 5000) │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│  任务队列     │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ Worker Thread│
│   + Agent    │
└──────────────┘
```

- **前端**: HTML + CSS + JavaScript
- **后端**: Flask + Server-Sent Events (SSE)
- **队列**: Python queue.Queue
- **AI**: TreeholeRAGAgent + DeepSeek

## 🚀 部署和管理

### 部署为系统服务

```bash
cd ~/pku-treehole-search-agent
sudo bash deploy_web_server.sh
```

### 管理命令

```bash
# 查看服务状态
sudo systemctl status treehole-web-server

# 查看实时日志
tail -f ~/pku-treehole-search-agent/logs/web_server.log

# 重启服务
sudo systemctl restart treehole-web-server

# 停止服务
sudo systemctl stop treehole-web-server

# 查看队列统计
curl http://localhost:5000/api/queue
```

### 直接运行（调试模式）

```bash
cd ~/pku-treehole-search-agent
bash start_web_server.sh
```

## 📊 API 接口

### 提交任务

```http
POST /api/submit
Content-Type: application/json

{
  "mode": 2,
  "params": {
    "question": "你的问题"
  }
}
```

### 流式输出

```http
GET /api/stream/{task_id}
Accept: text/event-stream
```

返回 SSE 事件流：
```
data: {"type": "status", "message": "开始处理..."}
data: {"type": "search_history", "message": "..."}
data: {"type": "answer", "message": "...", "sources": 10}
data: {"type": "complete"}
```

### 查看队列

```http
GET /api/queue

Response:
{
  "queue_size": 2,
  "active_tasks": 1,
  "total_tasks": 15
}
```

## 🔒 安全说明

- 服务仅监听内网 IP (10.129.83.176)
- 仅校园网内可访问
- 无需身份认证（内网环境）
- 建议不要暴露到公网

## 📝 使用限制

- 同时活跃连接数: 无限制
- 单次查询超时: 120 秒
- 任务队列大小: 无限制
- SSE 心跳间隔: 30 秒

## 🐛 故障排查

### 无法访问页面

1. 检查服务状态:
   ```bash
   sudo systemctl status treehole-web-server
   ```

2. 检查端口占用:
   ```bash
   ss -tlnp | grep 5000
   ```

3. 查看错误日志:
   ```bash
   tail -50 ~/pku-treehole-search-agent/logs/web_server.error.log
   ```

### 查询无响应

1. 查看工作线程日志:
   ```bash
   tail -f ~/pku-treehole-search-agent/logs/web_server.log
   ```

2. 检查 Agent 是否正常初始化

3. 重启服务:
   ```bash
   sudo systemctl restart treehole-web-server
   ```

## 💡 最佳实践

1. **使用智能检索模式**: 自然语言提问，最简单高效
2. **问题描述清晰**: 提供足够上下文帮助 AI 理解
3. **耐心等待**: 智能检索可能需要多轮搜索，需要 10-30 秒
4. **查看搜索历史**: 了解 AI 的搜索策略，优化问题
5. **多老师对比**: 课程测评时可以输入多个老师横向对比

## 🎯 相比邮件机器人的优势

| 特性 | Web 界面 | 邮件机器人 |
|------|---------|-----------|
| 响应速度 | ⚡ 实时 | 📧 15秒轮询 |
| 流式输出 | ✅ 支持 | ❌ 不支持 |
| 搜索可视化 | ✅ 实时显示 | ⚠️ 仅最终结果 |
| 多人使用 | ✅ 队列管理 | ✅ 并发处理 |
| 使用便捷性 | 🌐 浏览器 | 📱 邮件APP |
| 历史记录 | ⚠️ 无持久化 | ✅ 邮件保存 |

## 📱 移动端访问

在手机浏览器中打开 `http://10.129.83.176:5000` 即可使用，界面自动适配手机屏幕。

推荐使用 Safari (iOS) 或 Chrome (Android)。

---

**享受流畅的树洞检索体验！** 🎉
