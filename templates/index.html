<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å¤§æ ‘æ´æ£€ç´¢ Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-btn,
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .login-btn:hover,
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .username-display {
            color: white;
            font-size: 14px;
            opacity: 0.95;
        }

        /* Modalæ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        .modal-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background: #667eea;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #5568d3;
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        .modal-error {
            color: #f44336;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }
        
        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .login-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .login-tab:hover {
            color: #667eea;
        }
        
        .login-method {
            display: none;
        }
        
        .login-method.active {
            display: block;
        }
        
        .security-notice {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #1976d2;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .help-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }
        
        .steps-list {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .steps-list li {
            margin: 8px 0;
        }

        .content {
            padding: 30px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .output-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            display: none;
        }

        .output-section.active {
            display: block;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-running {
            background: #74b9ff;
            color: #0984e3;
        }

        .status-completed {
            background: #55efc4;
            color: #00b894;
        }

        .output-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .message-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-size: 13px;
        }

        .message-search {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            font-size: 13px;
        }

        .message-answer {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            font-size: 15px;
        }

        .message-error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            font-size: 13px;
        }

        .queue-status {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* Markdownæ¸²æŸ“æ ·å¼ */
        .message-answer {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .message-answer h1,
        .message-answer h2,
        .message-answer h3 {
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .message-answer h1 {
            font-size: 1.6em;
        }

        .message-answer h2 {
            font-size: 1.4em;
        }

        .message-answer h3 {
            font-size: 1.2em;
        }

        .message-answer ul,
        .message-answer ol {
            margin: 4px 0;
            padding-left: 25px;
        }

        .message-answer li {
            margin: 1px 0;
            line-height: 1.3;
        }

        .message-answer code {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .message-answer pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-width: 100%;
        }

        .message-answer pre code {
            background: transparent;
            padding: 0;
        }

        .message-answer blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin: 5px 0;
            color: #666;
        }

        .message-answer p {
            margin: 3px 0;
            line-height: 1.3;
        }

        .message-answer>*:first-child {
            margin-top: 0;
        }

        .message-answer>*:last-child {
            margin-bottom: 0;
        }

        .message-answer table {
            border-collapse: collapse;
            width: 100%;
            max-width: 100%;
            margin: 5px 0;
            overflow-x: auto;
            display: block;
        }

        .message-answer th,
        .message-answer td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .message-answer th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
    </style>
    <!-- Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <!-- ç™»å½•Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç™»å½•åŒ—å¤§æ ‘æ´</div>
            
            <!-- ç™»å½•æ–¹å¼é€‰æ‹© -->
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginMethod('token')">ğŸ” Tokenç™»å½•</button>
                <button class="login-tab" onclick="switchLoginMethod('password')">ğŸ”‘ å¯†ç ç™»å½•</button>
            </div>
            
            <!-- Tokenç™»å½•æ–¹å¼ -->
            <div id="tokenLogin" class="login-method active">
                <div class="security-notice">
                    âœ… æ¨èä½¿ç”¨æ­¤æ–¹å¼ï¼šæ‚¨çš„å¯†ç ä¸ç»è¿‡æœ¬æœåŠ¡å™¨ï¼Œæ›´å®‰å…¨
                </div>
                
                <div style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    <strong>è·å–Tokenæ­¥éª¤ï¼š</strong>
                    <ol class="steps-list">
                        <li>ç‚¹å‡»æ‰“å¼€ <a href="https://treehole.pku.edu.cn" target="_blank" class="help-link">æ ‘æ´å®˜ç½‘</a></li>
                        <li>åœ¨å®˜ç½‘ä½¿ç”¨IAAAè´¦å·ç™»å½•</li>
                        <li>ç™»å½•åæŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                        <li>åˆ‡æ¢åˆ°"Application"ï¼ˆåº”ç”¨ï¼‰æ ‡ç­¾</li>
                        <li>å·¦ä¾§é€‰æ‹© Cookies â†’ treehole.pku.edu.cn</li>
                        <li>æ‰¾åˆ°åä¸º <code>pku_token</code> çš„Cookieï¼Œå¤åˆ¶å…¶å€¼</li>
                        <li>ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†</li>
                    </ol>
                </div>
                
                <div class="modal-input-group">
                    <label>PKU Token</label>
                    <input type="text" id="loginToken" placeholder="ç²˜è´´ä»æ ‘æ´å®˜ç½‘è·å–çš„token">
                    <div class="help-text">
                        Tokenæ ¼å¼ç¤ºä¾‹ï¼šeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    </div>
                </div>
                
                <div class="modal-error" id="tokenLoginError"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="closeLoginModal()">å–æ¶ˆ</button>
                    <button class="modal-btn modal-btn-primary" onclick="performTokenLogin()">ä½¿ç”¨Tokenç™»å½•</button>
                </div>
            </div>
            
            <!-- å¯†ç ç™»å½•æ–¹å¼ -->
            <div id="passwordLogin" class="login-method">
                <div class="security-notice">
                    ğŸ”’ å¯†ç ä»…ç”¨äºè°ƒç”¨IAAAç™»å½•æ¥å£ï¼Œä¸ä¼šè¢«æœåŠ¡å™¨ä¿å­˜
                </div>
                
                <div class="modal-input-group">
                    <label>å­¦å·</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥å­¦å·">
                </div>
                <div class="modal-input-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <div class="help-text">
                        æ‚¨çš„å¯†ç é€šè¿‡HTTPSåŠ å¯†ä¼ è¾“ï¼Œç™»å½•åç«‹å³ä¸¢å¼ƒ
                    </div>
                </div>
                
                <div class="modal-error" id="passwordLoginError"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="closeLoginModal()">å–æ¶ˆ</button>
                    <button class="modal-btn modal-btn-primary" onclick="performPasswordLogin()">ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
            <div class="login-status">
                <span id="usernameDisplay" class="username-display" style="display: none;"></span>
                <button id="loginBtn" class="login-btn" onclick="showLoginModal()">ç™»å½•</button>
                <button id="logoutBtn" class="logout-btn" onclick="performLogout()" style="display: none;">ç™»å‡º</button>
            </div>
            
            <h1>ğŸŒ² åŒ—å¤§æ ‘æ´æ£€ç´¢ Agent</h1>
            <p>æ ¡å›­ç½‘å†…ç½‘æœåŠ¡ Â· 10.129.83.176:5000</p>
        </div>

        <div class="content">
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="mode-selector">
                <button class="mode-btn active" onclick="selectMode(1)">
                    <strong>æ‰‹åŠ¨æ£€ç´¢</strong><br>
                    <small>æŒ‡å®šå…³é”®è¯</small>
                </button>
                <button class="mode-btn" onclick="selectMode(2)">
                    <strong>æ™ºèƒ½æ£€ç´¢</strong><br>
                    <small>AIè‡ªåŠ¨æœç´¢</small>
                </button>
                <button class="mode-btn" onclick="selectMode(3)">
                    <strong>è¯¾ç¨‹æµ‹è¯„</strong><br>
                    <small>æ·±åº¦åˆ†æ</small>
                </button>
            </div>

            <!-- æ¨¡å¼1: æ‰‹åŠ¨æ£€ç´¢ -->
            <div id="mode1" class="mode-content">
                <div class="input-group">
                    <label>æœç´¢å…³é”®è¯</label>
                    <input type="text" id="keyword" placeholder="ä¾‹å¦‚: è®¡ç®—æœºç½‘ç»œ">
                </div>
                <div class="input-group">
                    <label>ä½ çš„é—®é¢˜</label>
                    <textarea id="question1" placeholder="ä¾‹å¦‚: è¿™é—¨è¯¾æ€ä¹ˆæ ·ï¼Ÿéš¾åº¦å¦‚ä½•ï¼Ÿ"></textarea>
                </div>
            </div>

            <!-- æ¨¡å¼2: æ™ºèƒ½æ£€ç´¢ -->
            <div id="mode2" class="mode-content hidden">
                <div class="input-group">
                    <label>ä½ çš„é—®é¢˜</label>
                    <textarea id="question2" placeholder="ä¾‹å¦‚: æˆ‘æƒ³äº†è§£è®¡ç®—æœºå›¾å½¢å­¦è¿™é—¨è¯¾ï¼Œä½œä¸šå¤šå—ï¼Ÿç»™åˆ†æ€ä¹ˆæ ·ï¼Ÿ"></textarea>
                </div>
            </div>

            <!-- æ¨¡å¼3: è¯¾ç¨‹æµ‹è¯„ -->
            <div id="mode3" class="mode-content hidden">
                <div class="input-group">
                    <label>è¯¾ç¨‹ç¼©å†™</label>
                    <input type="text" id="course" placeholder="ä¾‹å¦‚: è®¡ç½‘">
                </div>
                <div class="input-group">
                    <label>è€å¸ˆå§“åé¦–å­—æ¯ï¼ˆæ”¯æŒå¤šä¸ªï¼‰</label>
                    <input type="text" id="teacher" placeholder="ä¾‹å¦‚: hq æˆ– hq,zhx,yyx">
                </div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <button class="submit-btn" id="submitBtn" onclick="submitQuery()">
                å¼€å§‹æŸ¥è¯¢
            </button>

            <!-- è¾“å‡ºåŒºåŸŸ -->
            <div class="output-section" id="outputSection">
                <div class="status-badge" id="statusBadge">ç­‰å¾…ä¸­...</div>
                <div class="output-box" id="outputBox"></div>
            </div>

            <!-- é˜Ÿåˆ—çŠ¶æ€ -->
            <div class="queue-status" id="queueStatus">
                é˜Ÿåˆ—ä¸­: 0 ä¸ªä»»åŠ¡ | æ´»è·ƒè¿æ¥: 0
            </div>
        </div>
    </div>

    <script>
        // ç™»å½•ç›¸å…³å‡½æ•°
        let isLoggedIn = false;
        let username = '';
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('DOMContentLoaded', async () => {
            await checkLoginStatus();
        });
        
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/check_login', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.logged_in) {
                    isLoggedIn = true;
                    username = data.username;
                    updateLoginUI(true);
                } else {
                    isLoggedIn = false;
                    updateLoginUI(false);
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        function updateLoginUI(loggedIn) {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const usernameDisplay = document.getElementById('usernameDisplay');
            
            if (loggedIn) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                usernameDisplay.style.display = 'block';
                usernameDisplay.textContent = username;
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                usernameDisplay.style.display = 'none';
            }
        }
        
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            // é‡ç½®åˆ°Tokenç™»å½•tab
            switchLoginMethod('token');
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
            document.getElementById('loginToken').value = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('tokenLoginError').style.display = 'none';
            document.getElementById('passwordLoginError').style.display = 'none';
        }
        
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }
        
        function switchLoginMethod(method) {
            // åˆ‡æ¢tabæ¿€æ´»çŠ¶æ€
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            if (method === 'token') {
                tabs[0].classList.add('active');
                document.getElementById('tokenLogin').classList.add('active');
                document.getElementById('passwordLogin').classList.remove('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('passwordLogin').classList.add('active');
                document.getElementById('tokenLogin').classList.remove('active');
            }
        }
        
        async function performTokenLogin() {
            const token = document.getElementById('loginToken').value.trim();
            const errorDiv = document.getElementById('tokenLoginError');
            
            if (!token) {
                errorDiv.textContent = 'è¯·è¾“å…¥Token';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/login_by_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ token })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isLoggedIn = true;
                    username = data.username || 'Tokenç”¨æˆ·';
                    updateLoginUI(true);
                    closeLoginModal();
                    alert('Tokenç™»å½•æˆåŠŸï¼ç°åœ¨å°†ä½¿ç”¨æ‚¨çš„ä¸ªäººè´¦å·æ£€ç´¢æ ‘æ´');
                } else {
                    errorDiv.textContent = data.message || 'Tokenç™»å½•å¤±è´¥';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'ç™»å½•å‡ºé”™: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }
        
        async function performPasswordLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('passwordLoginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'è¯·å¡«å†™å­¦å·å’Œå¯†ç ';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isLoggedIn = true;
                    window.username = data.username;
                    updateLoginUI(true);
                    closeLoginModal();
                    alert('ç™»å½•æˆåŠŸï¼ç°åœ¨å°†ä½¿ç”¨æ‚¨çš„ä¸ªäººè´¦å·æ£€ç´¢æ ‘æ´');
                } else {
                    errorDiv.textContent = data.message || 'ç™»å½•å¤±è´¥';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'ç™»å½•å‡ºé”™: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }
        
        async function performLogout() {
            if (!confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isLoggedIn = false;
                    username = '';
                    updateLoginUI(false);
                    alert('ç™»å‡ºæˆåŠŸ');
                } else {
                    alert('ç™»å‡ºå¤±è´¥');
                }
            } catch (error) {
                alert('ç™»å‡ºå‡ºé”™: ' + error.message);
            }
        }
        
        // ç‚¹å‡»modalå¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('loginModal');
            if (event.target == modal) {
                closeLoginModal();
            }
        }
        
        // ä¸»ç¨‹åºé€»è¾‘
        let currentMode = 1;
        let currentTaskId = null;
        let eventSource = null;

        function selectMode(mode) {
            currentMode = mode;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === mode);
            });

            // æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥åŒºåŸŸ
            for (let i = 1; i <= 3; i++) {
                const element = document.getElementById(`mode${i}`);
                element.classList.toggle('hidden', i !== mode);
            }
        }

        async function submitQuery() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•åå†è¿›è¡ŒæŸ¥è¯¢ï¼\n\næ‚¨å¯ä»¥é€‰æ‹©ï¼š\n1. Tokenç™»å½•ï¼ˆæ¨èï¼‰- æ›´å®‰å…¨\n2. å¯†ç ç™»å½• - å¿«é€Ÿæ–¹ä¾¿');
                showLoginModal();
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const outputSection = document.getElementById('outputSection');
            const outputBox = document.getElementById('outputBox');
            const statusBadge = document.getElementById('statusBadge');

            // æ”¶é›†å‚æ•°
            let params = {};

            if (currentMode === 1) {
                const keyword = document.getElementById('keyword').value.trim();
                const question = document.getElementById('question1').value.trim();
                if (!keyword || !question) {
                    alert('è¯·å¡«å†™å…³é”®è¯å’Œé—®é¢˜');
                    return;
                }
                params = { keyword, question };
            } else if (currentMode === 2) {
                const question = document.getElementById('question2').value.trim();
                if (!question) {
                    alert('è¯·å¡«å†™é—®é¢˜');
                    return;
                }
                params = { question };
            } else if (currentMode === 3) {
                const course = document.getElementById('course').value.trim();
                const teacher = document.getElementById('teacher').value.trim();
                if (!course || !teacher) {
                    alert('è¯·å¡«å†™è¯¾ç¨‹å’Œè€å¸ˆ');
                    return;
                }
                params = { course, teacher };
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            // æ¸…ç©ºè¾“å‡ºå’Œæµå¼çŠ¶æ€
            outputBox.innerHTML = '';
            streamElement = null;
            streamBuffer = '';
            outputSection.classList.add('active');
            statusBadge.textContent = 'æ’é˜Ÿä¸­...';
            statusBadge.className = 'status-badge status-pending loading';

            try {
                // æäº¤ä»»åŠ¡
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: currentMode, params })
                });

                const result = await response.json();

                if (result.success) {
                    currentTaskId = result.task_id;
                    addMessage('info', `ä»»åŠ¡å·²æäº¤ (ID: ${currentTaskId})`);

                    // å»ºç«‹SSEè¿æ¥
                    connectSSE(currentTaskId);
                } else {
                    addMessage('error', `æäº¤å¤±è´¥: ${result.message}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
                }

            } catch (error) {
                addMessage('error', `æäº¤å‡ºé”™: ${error.message}`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            }
        }

        function connectSSE(taskId) {
            const statusBadge = document.getElementById('statusBadge');

            // å…³é—­æ—§è¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // å»ºç«‹æ–°è¿æ¥
            eventSource = new EventSource(`/api/stream/${taskId}`);

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'connected') {
                    addMessage('info', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç­‰å¾…å¤„ç†...', false);
                } else if (data.type === 'status') {
                    statusBadge.textContent = data.message;
                    if (data.status === 'running') {
                        statusBadge.className = 'status-badge status-running loading';
                    }
                } else if (data.type === 'info') {
                    addMessage('info', data.message, false);
                } else if (data.type === 'search_history') {
                    addMessage('search', data.message, false);
                } else if (data.type === 'stream') {
                    // æµå¼å†…å®¹ï¼Œè¿½åŠ åˆ°æµå¼æ˜¾ç¤ºåŒºåŸŸ
                    appendStream(data.content);
                } else if (data.type === 'metadata') {
                    // å…ƒæ•°æ®ï¼ˆæ¥æºä¿¡æ¯ç­‰ï¼‰
                    addMessage('info', `å‚è€ƒæ¥æº: ${data.sources} ä¸ªå¸–å­`, false);
                } else if (data.type === 'error') {
                    addMessage('error', data.message, false);
                } else if (data.type === 'complete') {
                    statusBadge.textContent = 'âœ“ å®Œæˆ';
                    statusBadge.className = 'status-badge status-completed';
                    eventSource.close();

                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
                } else if (data.type === 'heartbeat') {
                    // å¿ƒè·³ï¼Œä¿æŒè¿æ¥
                }
            };

            eventSource.onerror = function (error) {
                console.error('SSEé”™è¯¯:', error);
                eventSource.close();

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            };
        }

        // æµå¼å†…å®¹çš„ç®¡ç†
        let streamElement = null;
        let streamBuffer = '';

        function appendStream(content) {
            streamBuffer += content;

            // å¦‚æœè¿˜æ²¡æœ‰æµå¼æ˜¾ç¤ºåŒºåŸŸï¼Œåˆ›å»ºä¸€ä¸ª
            if (!streamElement) {
                const outputBox = document.getElementById('outputBox');
                streamElement = document.createElement('div');
                streamElement.className = 'message message-answer';
                outputBox.appendChild(streamElement);
            }

            // ä½¿ç”¨marked.jså°†Markdownæ¸²æŸ“ä¸ºHTML
            streamElement.innerHTML = marked.parse(streamBuffer);

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const outputBox = document.getElementById('outputBox');
            outputBox.scrollTop = outputBox.scrollHeight;
        }

        function addMessage(type, text, useMarkdown = true) {
            const outputBox = document.getElementById('outputBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            // å¦‚æœæ˜¯answerç±»å‹æˆ–è€…éœ€è¦ä½¿ç”¨Markdownï¼Œå°±æ¸²æŸ“Markdown
            if (useMarkdown && (type === 'answer' || type === 'search' || type === 'info')) {
                messageDiv.innerHTML = marked.parse(text);
            } else {
                messageDiv.textContent = text;
            }

            outputBox.appendChild(messageDiv);
            outputBox.scrollTop = outputBox.scrollHeight;
        }

        // å®šæœŸæ›´æ–°é˜Ÿåˆ—çŠ¶æ€
        setInterval(async () => {
            try {
                const response = await fetch('/api/queue');
                const data = await response.json();
                const queueStatus = document.getElementById('queueStatus');
                queueStatus.textContent = `é˜Ÿåˆ—ä¸­: ${data.queue_size} ä¸ªä»»åŠ¡ | æ´»è·ƒè¿æ¥: ${data.active_tasks}`;
            } catch (error) {
                console.error('è·å–é˜Ÿåˆ—çŠ¶æ€å¤±è´¥:', error);
            }
        }, 5000);
    </script>
</body>

</html>