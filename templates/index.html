<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å¤§æ ‘æ´æ£€ç´¢ Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .output-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            display: none;
        }

        .output-section.active {
            display: block;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-running {
            background: #74b9ff;
            color: #0984e3;
        }

        .status-completed {
            background: #55efc4;
            color: #00b894;
        }

        .output-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: "SF Mono", Monaco, "Andale Mono", monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .message-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-size: 13px;
        }

        .message-search {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            font-size: 13px;
        }

        .message-answer {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            font-size: 15px;
        }

        .message-error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            font-size: 13px;
        }

        .queue-status {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
        
        /* Markdownæ¸²æŸ“æ ·å¼ */
        .message-answer {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .message-answer h1, .message-answer h2, .message-answer h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .message-answer h1 {
            font-size: 1.6em;
        }
        
        .message-answer h2 {
            font-size: 1.4em;
        }
        
        .message-answer h3 {
            font-size: 1.2em;
        }
        
        .message-answer ul, .message-answer ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .message-answer li {
            margin: 5px 0;
        }
        
        .message-answer code {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .message-answer pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-width: 100%;
        }
        
        .message-answer pre code {
            background: transparent;
            padding: 0;
        }
        
        .message-answer blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin: 10px 0;
            color: #666;
        }
        
        .message-answer p {
            margin: 10px 0;
            line-height: 1.7;
        }
        
        .message-answer table {
            border-collapse: collapse;
            width: 100%;
            max-width: 100%;
            margin: 10px 0;
            overflow-x: auto;
            display: block;
        }
        
        .message-answer th, .message-answer td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .message-answer th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
    </style>
    <!-- Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ² åŒ—å¤§æ ‘æ´æ£€ç´¢ Agent</h1>
            <p>æ ¡å›­ç½‘å†…ç½‘æœåŠ¡ Â· 10.129.83.176:5000</p>
        </div>

        <div class="content">
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="mode-selector">
                <button class="mode-btn active" onclick="selectMode(1)">
                    <strong>æ‰‹åŠ¨æ£€ç´¢</strong><br>
                    <small>æŒ‡å®šå…³é”®è¯</small>
                </button>
                <button class="mode-btn" onclick="selectMode(2)">
                    <strong>æ™ºèƒ½æ£€ç´¢</strong><br>
                    <small>AIè‡ªåŠ¨æœç´¢</small>
                </button>
                <button class="mode-btn" onclick="selectMode(3)">
                    <strong>è¯¾ç¨‹æµ‹è¯„</strong><br>
                    <small>æ·±åº¦åˆ†æ</small>
                </button>
            </div>

            <!-- æ¨¡å¼1: æ‰‹åŠ¨æ£€ç´¢ -->
            <div id="mode1" class="mode-content">
                <div class="input-group">
                    <label>æœç´¢å…³é”®è¯</label>
                    <input type="text" id="keyword" placeholder="ä¾‹å¦‚: è®¡ç®—æœºç½‘ç»œ">
                </div>
                <div class="input-group">
                    <label>ä½ çš„é—®é¢˜</label>
                    <textarea id="question1" placeholder="ä¾‹å¦‚: è¿™é—¨è¯¾æ€ä¹ˆæ ·ï¼Ÿéš¾åº¦å¦‚ä½•ï¼Ÿ"></textarea>
                </div>
            </div>

            <!-- æ¨¡å¼2: æ™ºèƒ½æ£€ç´¢ -->
            <div id="mode2" class="mode-content hidden">
                <div class="input-group">
                    <label>ä½ çš„é—®é¢˜</label>
                    <textarea id="question2" placeholder="ä¾‹å¦‚: æˆ‘æƒ³äº†è§£è®¡ç®—æœºå›¾å½¢å­¦è¿™é—¨è¯¾ï¼Œä½œä¸šå¤šå—ï¼Ÿç»™åˆ†æ€ä¹ˆæ ·ï¼Ÿ"></textarea>
                </div>
            </div>

            <!-- æ¨¡å¼3: è¯¾ç¨‹æµ‹è¯„ -->
            <div id="mode3" class="mode-content hidden">
                <div class="input-group">
                    <label>è¯¾ç¨‹ç¼©å†™</label>
                    <input type="text" id="course" placeholder="ä¾‹å¦‚: è®¡ç½‘">
                </div>
                <div class="input-group">
                    <label>è€å¸ˆå§“åé¦–å­—æ¯ï¼ˆæ”¯æŒå¤šä¸ªï¼‰</label>
                    <input type="text" id="teacher" placeholder="ä¾‹å¦‚: hq æˆ– hq,zhx,yyx">
                </div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <button class="submit-btn" id="submitBtn" onclick="submitQuery()">
                å¼€å§‹æŸ¥è¯¢
            </button>

            <!-- è¾“å‡ºåŒºåŸŸ -->
            <div class="output-section" id="outputSection">
                <div class="status-badge" id="statusBadge">ç­‰å¾…ä¸­...</div>
                <div class="output-box" id="outputBox"></div>
            </div>

            <!-- é˜Ÿåˆ—çŠ¶æ€ -->
            <div class="queue-status" id="queueStatus">
                é˜Ÿåˆ—ä¸­: 0 ä¸ªä»»åŠ¡ | æ´»è·ƒè¿æ¥: 0
            </div>
        </div>
    </div>

    <script>
        let currentMode = 1;
        let currentTaskId = null;
        let eventSource = null;

        function selectMode(mode) {
            currentMode = mode;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === mode);
            });

            // æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥åŒºåŸŸ
            for (let i = 1; i <= 3; i++) {
                const element = document.getElementById(`mode${i}`);
                element.classList.toggle('hidden', i !== mode);
            }
        }

        async function submitQuery() {
            const submitBtn = document.getElementById('submitBtn');
            const outputSection = document.getElementById('outputSection');
            const outputBox = document.getElementById('outputBox');
            const statusBadge = document.getElementById('statusBadge');

            // æ”¶é›†å‚æ•°
            let params = {};

            if (currentMode === 1) {
                const keyword = document.getElementById('keyword').value.trim();
                const question = document.getElementById('question1').value.trim();
                if (!keyword || !question) {
                    alert('è¯·å¡«å†™å…³é”®è¯å’Œé—®é¢˜');
                    return;
                }
                params = { keyword, question };
            } else if (currentMode === 2) {
                const question = document.getElementById('question2').value.trim();
                if (!question) {
                    alert('è¯·å¡«å†™é—®é¢˜');
                    return;
                }
                params = { question };
            } else if (currentMode === 3) {
                const course = document.getElementById('course').value.trim();
                const teacher = document.getElementById('teacher').value.trim();
                if (!course || !teacher) {
                    alert('è¯·å¡«å†™è¯¾ç¨‹å’Œè€å¸ˆ');
                    return;
                }
                params = { course, teacher };
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            // æ¸…ç©ºè¾“å‡ºå’Œæµå¼çŠ¶æ€
            outputBox.innerHTML = '';
            streamElement = null;
            streamBuffer = '';
            outputSection.classList.add('active');
            statusBadge.textContent = 'æ’é˜Ÿä¸­...';
            statusBadge.className = 'status-badge status-pending loading';

            try {
                // æäº¤ä»»åŠ¡
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: currentMode, params })
                });

                const result = await response.json();

                if (result.success) {
                    currentTaskId = result.task_id;
                    addMessage('info', `ä»»åŠ¡å·²æäº¤ (ID: ${currentTaskId})`);

                    // å»ºç«‹SSEè¿æ¥
                    connectSSE(currentTaskId);
                } else {
                    addMessage('error', `æäº¤å¤±è´¥: ${result.message}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
                }

            } catch (error) {
                addMessage('error', `æäº¤å‡ºé”™: ${error.message}`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            }
        }

        function connectSSE(taskId) {
            const statusBadge = document.getElementById('statusBadge');

            // å…³é—­æ—§è¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // å»ºç«‹æ–°è¿æ¥
            eventSource = new EventSource(`/api/stream/${taskId}`);

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'connected') {
                    addMessage('info', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç­‰å¾…å¤„ç†...', false);
                } else if (data.type === 'status') {
                    statusBadge.textContent = data.message;
                    if (data.status === 'running') {
                        statusBadge.className = 'status-badge status-running loading';
                    }
                } else if (data.type === 'info') {
                    addMessage('info', data.message, false);
                } else if (data.type === 'search_history') {
                    addMessage('search', data.message, false);
                } else if (data.type === 'stream') {
                    // æµå¼å†…å®¹ï¼Œè¿½åŠ åˆ°æµå¼æ˜¾ç¤ºåŒºåŸŸ
                    appendStream(data.content);
                } else if (data.type === 'metadata') {
                    // å…ƒæ•°æ®ï¼ˆæ¥æºä¿¡æ¯ç­‰ï¼‰
                    addMessage('info', `å‚è€ƒæ¥æº: ${data.sources} ä¸ªå¸–å­`, false);
                } else if (data.type === 'error') {
                    addMessage('error', data.message, false);
                } else if (data.type === 'complete') {
                    statusBadge.textContent = 'âœ“ å®Œæˆ';
                    statusBadge.className = 'status-badge status-completed';
                    eventSource.close();

                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
                } else if (data.type === 'heartbeat') {
                    // å¿ƒè·³ï¼Œä¿æŒè¿æ¥
                }
            };

            eventSource.onerror = function (error) {
                console.error('SSEé”™è¯¯:', error);
                eventSource.close();

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            };
        }

        // æµå¼å†…å®¹çš„ç®¡ç†
        let streamElement = null;
        let streamBuffer = '';

        function appendStream(content) {
            streamBuffer += content;
            
            // å¦‚æœè¿˜æ²¡æœ‰æµå¼æ˜¾ç¤ºåŒºåŸŸï¼Œåˆ›å»ºä¸€ä¸ª
            if (!streamElement) {
                const outputBox = document.getElementById('outputBox');
                streamElement = document.createElement('div');
                streamElement.className = 'message message-answer';
                outputBox.appendChild(streamElement);
            }
            
            // ä½¿ç”¨marked.jså°†Markdownæ¸²æŸ“ä¸ºHTML
            streamElement.innerHTML = marked.parse(streamBuffer);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            const outputBox = document.getElementById('outputBox');
            outputBox.scrollTop = outputBox.scrollHeight;
        }

        function addMessage(type, text, useMarkdown = true) {
            const outputBox = document.getElementById('outputBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            
            // å¦‚æœæ˜¯answerç±»å‹æˆ–è€…éœ€è¦ä½¿ç”¨Markdownï¼Œå°±æ¸²æŸ“Markdown
            if (useMarkdown && (type === 'answer' || type === 'search' || type === 'info')) {
                messageDiv.innerHTML = marked.parse(text);
            } else {
                messageDiv.textContent = text;
            }
            
            outputBox.appendChild(messageDiv);
            outputBox.scrollTop = outputBox.scrollHeight;
        }

        // å®šæœŸæ›´æ–°é˜Ÿåˆ—çŠ¶æ€
        setInterval(async () => {
            try {
                const response = await fetch('/api/queue');
                const data = await response.json();
                const queueStatus = document.getElementById('queueStatus');
                queueStatus.textContent = `é˜Ÿåˆ—ä¸­: ${data.queue_size} ä¸ªä»»åŠ¡ | æ´»è·ƒè¿æ¥: ${data.active_tasks}`;
            } catch (error) {
                console.error('è·å–é˜Ÿåˆ—çŠ¶æ€å¤±è´¥:', error);
            }
        }, 5000);
    </script>
</body>

</html>